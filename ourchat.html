<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OurChat – SPELLs</title>

<style>
    body {
        margin: 0;
        background: #0e1117;
        font-family: "Helvetica", "Arial", sans-serif;
        color: #e6e6e6;
    }

    header {
        padding: 20px;
        text-align: center;
        font-size: 2rem;
        font-weight: bold;
        color: #88c0ff;
        border-bottom: 1px solid #222;
    }

    /* login screen */
    #login-box {
        max-width: 350px;
        margin: 120px auto;
        padding: 20px;
        background: #1a1d24;
        border-radius: 12px;
        box-shadow: 0 0 18px rgba(0,0,0,0.4);
        display: none;
    }
    #login-box input {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        margin-bottom: 15px;
        background: #0e1117;
        color: white;
    }
    #login-box button {
        width: 100%;
        padding: 12px;
        background: #88c0ff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    /* main layout */
    #main {
        display: none;
        padding: 20px;
    }

    #top-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
    }

    #search {
        flex: 1;
        min-width: 200px;
        padding: 10px;
        border-radius: 8px;
        border: none;
        background: #1a1d24;
        color: white;
    }

    .tag {
        padding: 6px 10px;
        background: #1a1d24;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
    }
    .tag.active {
        background: #88c0ff;
        color: #000;
        font-weight: bold;
    }

    /* timeline cards */
    .card {
        padding: 18px;
        margin-bottom: 15px;
        background: #1a1d24;
        border-radius: 12px;
        box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .card-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #88c0ff;
    }
    .tags {
        margin-top: 5px;
        color: #aaa;
        font-size: 0.9rem;
    }
    .card a {
        text-decoration: none;
        color: #fff;
        padding: 8px 12px;
        background: #334;
        border-radius: 8px;
        display: inline-block;
        margin-top: 10px;
    }

    /* pagination */
    #pagination {
        margin-top: 25px;
        text-align: center;
    }
    .page-btn {
        margin: 0 6px;
        padding: 6px 12px;
        background: #1a1d24;
        border-radius: 6px;
        cursor: pointer;
    }
    .page-btn.active {
        background: #88c0ff;
        color: #000;
    }

</style>
</head>

<body>


<div class="wrap" id="top">
  <header>
    <div class="brand">
      <div class="logo">SPELLs</div>
      <div>
        <h1>DeepChat with AI</h1>
        <p class="lead">What have we learned from Deepchat with AI?</p>
      </div>
    </div>
    <div class="controls" aria-hidden="true">
      <a class="btn secondary" href="index.html">Back Home</a>
    </div>
  </header>
</div>
<!-- login screen -->
<div id="login-box">
    <h3 style="text-align:center;margin-bottom:20px;">请输入访问密码</h3>
    <input type="password" id="password" placeholder="Password" />
    <button onclick="checkPassword()">进入</button>
</div>

<!-- main content -->
<div id="main">

    <!-- featured top 5 -->
    <h2 style="color:#88c0ff;margin-top:5px;">精选主题（Top 5）</h2>
    <div id="featured"></div>

    <hr style="border-color:#222;margin:25px 0;">

    <!-- controls -->
    <div id="top-controls">
        <input id="search" placeholder="搜索标题 或 标签..." />
        <div class="tag" onclick="toggleTag('物理')">物理</div>
        <div class="tag" onclick="toggleTag('生活')">生活</div>
        <div class="tag" onclick="toggleTag('运动')">运动</div>
        <div class="tag" onclick="toggleTag('神经')">神经</div>
        <div class="tag" onclick="toggleTag('人生')">人生</div>
    </div>

    <!-- timeline -->
    <div id="list"></div>

    <!-- pagination -->
    <div id="pagination"></div>
</div>


<script>
/* --------------------------
   1. Password shared
-------------------------- */
const PASSWORD = "spells2023"; // ← 修改为你的密码

function checkPassword() {
    let p = document.getElementById("password").value;
    if (p === PASSWORD) {
        localStorage.setItem("auth", "ok");
        showMain();
    } else {
        alert("密码错误");
    }
}

function showMain() {
    document.getElementById("login-box").style.display = "none";
    document.getElementById("main").style.display = "block";
}

if (localStorage.getItem("auth") === "ok") showMain();
else document.getElementById("login-box").style.display = "block";


/* --------------------------
   2. Load PDFs automatically
-------------------------- */

let allData = [];
let activeTags = new Set();
let currentPage = 1;
const perPage = 20;

async function loadPDFs() {
    try {
        let res = await fetch("./deepchat/");
        let text = await res.text();

        let files = [...text.matchAll(/href="([^"]+\.pdf)"/g)].map(m => m[1]);

        files.forEach(f => {
            let match = f.match(/^(\d{8})\s*-\s*(.*?)\s*-\s*(.*?)\.pdf$/);
            if (!match) return;

            let date = match[1];
            let title = match[2];
            let tags = match[3].split(",");

            allData.push({
                date,
                title,
                pdf: "deepchat/" + f,
                tags
            });
        });

        // sort by date DESC
        allData.sort((a,b)=> b.date.localeCompare(a.date));

        renderFeatured();
        render();
    } catch(e){
        console.log("无法列出 PDF（GitHub Pages 需要开启目录索引）", e);
    }
}

loadPDFs();


/* --------------------------
   3. Featured Top 5
-------------------------- */
function renderFeatured() {
    let box = document.getElementById("featured");
    box.innerHTML = "";

    allData.slice(0,5).forEach(d=>{
        let div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            <div class="card-title">${d.title}</div>
            <div class="tags">${d.tags.join(" / ")}</div>
            <a href="${d.pdf}" target="_blank">打开 PDF</a>
        `;
        box.appendChild(div);
    });
}


/* --------------------------
   4. Filtering + Search
-------------------------- */

document.getElementById("search").addEventListener("input", ()=> {
    currentPage = 1;
    render();
});

function toggleTag(tag){
    if (activeTags.has(tag)) activeTags.delete(tag);
    else activeTags.add(tag);

    document.querySelectorAll(".tag").forEach(t=>{
        if (activeTags.has(t.innerText)) t.classList.add("active");
        else t.classList.remove("active");
    });

    currentPage = 1;
    render();
}

/* --------------------------
   5. Render Timeline with pagination
-------------------------- */

function render(){
    let search = document.getElementById("search").value.trim();
    let filtered = allData.filter(d=>{
        let ok = true;

        if (search){
            ok = (d.title.includes(search) ||
                  d.tags.some(t=> t.includes(search)));
        }

        if (activeTags.size>0){
            ok = ok && d.tags.some(t=> activeTags.has(t));
        }

        return ok;
    });

    let list = document.getElementById("list");
    list.innerHTML = "";

    let totalPages = Math.ceil(filtered.length / perPage);
    currentPage = Math.min(currentPage, totalPages);

    let start = (currentPage-1)*perPage;
    let pageData = filtered.slice(start, start+perPage);

    pageData.forEach(d=>{
        let div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            <div class="card-title">${d.title}</div>
            <div style="color:#999;margin:4px 0;">${d.date}</div>
            <div class="tags">${d.tags.join(" / ")}</div>
            <a href="${d.pdf}" target="_blank">打开 PDF</a>
        `;
        list.appendChild(div);
    });

    // pagination
    let pg = document.getElementById("pagination");
    pg.innerHTML = "";
    for (let i=1; i<=totalPages; i++){
        let b = document.createElement("span");
        b.className = "page-btn" + (i===currentPage?" active":"");
        b.innerText = i;
        b.onclick = ()=>{ currentPage=i; render(); };
        pg.appendChild(b);
    }
}

</script>

</body>
</html>
